<!DOCTYPE html>
<html>
<head>
    <title>Guide-Us: Hyperlocal Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
        .chat-box { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .status { padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .status.live { background-color: #d4edda; color: #155724; }
        .status.scout { background-color: #cce5ff; color: #004085; }
        .error { color: red; font-size: 0.9em; }
    </style>
</head>
<body>
    <h2>Community Chat: <span id="room-name">Goa</span></h2>
    
    <div>
        <input type="text" id="username" placeholder="Your Name" value="Traveler1"/>
        <button onclick="getLocationAndConnect()">üìç Join with GPS</button>
        <button onclick="connectWithoutGPS()">üî≠ Join as Scout</button>
    </div>
    
    <p id="gps-status" class="error"></p>

    <hr/>

    <div id="status-box" class="status" style="display:none;"></div>
    <div id="messages" class="chat-box"></div>
    
    <input type="text" id="messageText" placeholder="Type a message..." disabled/>
    <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>

    <script>
        var ws = null;
        var city = "kharghar"; // Target City

        // 1. TRY TO GET GPS
        function getLocationAndConnect() {
            var status = document.querySelector('#gps-status');
            
            if (!navigator.geolocation) {
                status.textContent = "Geolocation is not supported by your browser";
                return;
            }

            status.textContent = "Locating‚Ä¶";

            navigator.geolocation.getCurrentPosition(success, error);

            function success(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                status.textContent = `Found you at: ${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
                connect(latitude, longitude);
            }

            function error() {
                status.textContent = "Unable to retrieve your location. Joining as Scout.";
                connectWithoutGPS(); // Fallback to Scout Mode
            }
        }

        // 2. JOIN WITHOUT GPS (Scout Mode)
        function connectWithoutGPS() {
            connect(null, null);
        }

        // 3. CONNECT TO WEBSOCKET
        function connect(lat, lon) {
            var user = document.getElementById("username").value;
            var url = "ws://localhost:8000/ws/" + city + "/" + user;

            // Append GPS if we have it
            if (lat && lon) {
                url += `?lat=${lat}&lon=${lon}`;
            }

            ws = new WebSocket(url);

            ws.onopen = function() {
                document.getElementById("gps-status").textContent = "Connected!";
            };

            ws.onmessage = function(event) {
                var messages = document.getElementById('messages');
                var statusBox = document.getElementById('status-box');
                var input = document.getElementById("messageText");
                var btn = document.getElementById("sendBtn");

                // Check for System Messages (verified/scout)
                if (event.data.includes("‚úÖ GPS Verified")) {
                    statusBox.style.display = "block";
                    statusBox.className = "status live";
                    statusBox.textContent = event.data;
                    input.disabled = false; // Enable typing
                    btn.disabled = false;
                } 
                else if (event.data.includes("üî≠ SCOUT MODE")) {
                    statusBox.style.display = "block";
                    statusBox.className = "status scout";
                    statusBox.textContent = event.data;
                    input.disabled = true; // Disable typing
                    btn.disabled = true;
                    input.placeholder = "Read-Only Mode (You are too far away)";
                } 
                else {
                    // Normal Chat Message
                    var message = document.createElement('div');
                    var content = document.createTextNode(event.data);
                    message.appendChild(content);
                    messages.appendChild(message);
                    // Auto-scroll to bottom
                    messages.scrollTop = messages.scrollHeight; 
                }
            };
        }

        function sendMessage() {
            var input = document.getElementById("messageText");
            if (input.value.trim() !== "") {
                ws.send(input.value);
                input.value = '';
            }
        }
    </script>
</body>
</html>